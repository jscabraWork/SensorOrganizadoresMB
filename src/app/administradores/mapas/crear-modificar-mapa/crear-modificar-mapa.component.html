<div class="map-editor-container">
  <!-- Header section -->
  <div class="editor-header">
    <div class="header-content">
      <h1 class="title">{{mapaId ? 'Modificar Mapa' : 'Crear Mapa'}}</h1>
      
      <div class="header-controls">        <div class="form-group">
          <label for="eventoSelect">Evento:</label>
          <select id="eventoSelect" [(ngModel)]="eventoSeleccionado" class="form-control" [disabled]="modoEdicion">
            <option value="">Seleccionar evento</option>
            <option *ngFor="let evento of eventos" [ngValue]="evento">{{evento.nombre}}</option>
          </select>
        </div>
          <!-- Botón de Preview -->
        <button type="button" class="btn-secondary" (click)="togglePreview()" [class.active]="modoPreview">
          <i class="fas fa-eye"></i> {{modoPreview ? 'Editar' : 'Vista Previa'}}
        </button>
        
        <button type="button" class="btn-primary" (click)="guardarMapa()" [disabled]="guardando" [class.hidden-preview]="modoPreview">
          <i class="fas fa-save"></i> {{guardando ? 'Guardando...' : 'Guardar Mapa'}}
        </button>
        
        <button type="button" class="btn-outline-primary" (click)="atras()" [class.hidden-preview]="modoPreview">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>
  </div>
  <!-- Main 3-panel layout -->
  <div class="editor-layout">
    <!-- Left panel - Style editor (hidden in preview mode) -->
    <div class="left-panel" [class.closed]="!panelEstilosAbierto" [class.hidden-preview]="modoPreview">
      <div class="panel-header">
        <h3 class="panel-title">
          <i class="fas fa-palette icon"></i>
          Editor de Estilos
        </h3>
        <button type="button" class="close-btn" (click)="cancelarSeleccion()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="panel-content">
        <div *ngIf="elementoSeleccionado">          <!-- Editor para Fila -->
          <app-propiedades-fila
            *ngIf="tipoElementoSeleccionado === 'fila'"
            [fila]="obtenerFilaSeleccionada()!"
            [estilosDisponibles]="estilosDisponibles"
            [evento]="eventoSeleccionado"
            [getEstilosAsiento]="getEstilosAsiento"
            (filaChange)="onElementoChange($event)"
            (eliminar)="eliminarElemento()">
          </app-propiedades-fila>

          <!-- Editor para Asiento -->
          <app-propiedades-asiento
            *ngIf="tipoElementoSeleccionado === 'asiento'"
            [asiento]="obtenerAsientoSeleccionado()!"
            [estilosDisponibles]="estilosDisponibles"
            [formasDisponibles]="formasDisponibles"
            (asientoChange)="onElementoChange($event)"
            (eliminar)="eliminarElemento()">
          </app-propiedades-asiento>          <!-- Editor para Forma -->
          <app-propiedades-forma 
            *ngIf="tipoElementoSeleccionado === 'forma'"
            [forma]="obtenerFormaSeleccionada()!"
            [estilosDisponibles]="estilosDisponibles"
            [localidadesDisponibles]="localidadesDisponibles"
            (formaChange)="onFormaChange($event)"
            (eliminar)="eliminarElemento()">
          </app-propiedades-forma>
        </div>

        <div *ngIf="!elementoSeleccionado" class="sin-seleccion">
          <p>Selecciona un elemento del mapa para editar sus propiedades</p>
        </div>
      </div>
    </div>    <!-- Center panel - Canvas -->
    <div class="center-panel">
      <div class="canvas-toolbar" [class.hidden-preview]="modoPreview">
        <div class="toolbar-section">
          <button type="button" class="btn btn-primary" (click)="agregarFila()">
            <i class="fas fa-plus"></i> Agregar Fila
          </button>
          <button type="button" class="btn btn-secondary" (click)="agregarForma()">
            <i class="fas fa-shapes"></i> Agregar Forma
          </button>
        </div>
        
        <div class="toolbar-section">
          <label>Ancho:</label>
          <input type="number" [(ngModel)]="mapa.ancho" class="form-control" min="100" style="width: 80px;">
          <label>Alto:</label>
          <input type="number" [(ngModel)]="mapa.alto" class="form-control" min="100" style="width: 80px;">
        </div>
      </div>

      <div class="canvas-container">
        <div class="map-canvas" 
             [style.width.px]="mapa.ancho" 
             [style.height.px]="mapa.alto"
             [class.preview-mode]="modoPreview"
             (click)="cancelarSeleccion()"
             (drop)="!modoPreview && onDrop($event)" 
             (dragover)="!modoPreview && onDragOver($event)"
             (dragleave)="!modoPreview && onDragLeave($event)">
          
          <div class="canvas-content">            <!-- Filas del mapa (libres) -->            <div *ngFor="let fila of mapa.filas; let i = index; trackBy: trackByFila"
                 class="fila-element"
                 [style.left.px]="fila.estilo?.positionX || 50"
                 [style.top.px]="fila.estilo?.positionY || 50"
                 [style.transform]="'rotate(' + (fila.estilo?.rotation|| 0) + 'deg)'"
                 [class.selected]="elementoSeleccionado === fila && !modoPreview"
                 [class.preview-mode]="modoPreview"
                 (click)="!modoPreview && seleccionarElemento(fila, 'fila', {filaIndex: i}); $event.stopPropagation()"
                 [draggable]="!modoPreview"
                 (dragstart)="!modoPreview && onDragStart($event, fila, 'fila')"
                 (dragend)="!modoPreview && onDragEnd($event)"
                 [ngStyle]="{
                   'border': (fila.asientos?.length === 0 && !modoPreview) ? '1px dashed #bbb' : (fila.asientos?.length === 0 && modoPreview) ? 'none' : null,
                   'min-width': (fila.asientos?.length === 0) ? '60px' : null,
                   'min-height': (fila.asientos?.length === 0) ? '40px' : null
                 }">
              <!-- Handle de rotación -->
              <div *ngIf="!modoPreview && elementoSeleccionado === fila"
                   class="rotation-handle"
                   (mousedown)="onRotationHandleMouseDown($event, fila)"
                   title="Rotar">
                <i class="fas fa-undo-alt"></i>
                <span *ngIf="isRotating && rotationPreview !== null" class="rotation-angle-label">{{ rotationPreview }}°</span>
              </div>
              <!-- Botón eliminar fila -->
              <button *ngIf="!modoPreview" 
                      class="icon-delete-corner" 
                      (click)="eliminarFila(i, $event); $event.stopPropagation()" 
                      title="Eliminar">
                <i class="fas fa-times"></i>
                <span class="delete-tooltip">Eliminar</span>
              </button>
              <!-- Visual Seats within Row -->
              <div class="asientos-visual-container" 
                   [style.gap.px]="fila.separacion || 0"
                   [style.transform]="getFilaCurvatura(fila)">                <div *ngFor="let asiento of fila.asientos; let j = index; trackBy: trackByAsiento"
                     class="asiento-visual"
                     [style.width.px]="getEstilosAsiento(asiento, fila).width"
                     [style.height.px]="getEstilosAsiento(asiento, fila).height"
                     [style.margin-left.px]="asiento.margenL || 0"
                     [style.margin-right.px]="asiento.margenR || 0"
                     [style.background-color]="getEstilosAsiento(asiento, fila).backgroundColor"
                     [style.border-color]="getEstilosAsiento(asiento, fila).borderColor"
                     [style.border-width.px]="getEstilosAsiento(asiento, fila).borderWidth"
                     [style.border-radius]="getEstilosAsiento(asiento, fila).borderRadius + 'px'"
                     [style.transform]="'rotate(' + getRotacion(asiento) + 'deg)'"
                     [class.seleccionado]="elementoSeleccionado === asiento && !modoPreview"
                     [class.preview-mode]="modoPreview"
                     [class.disponible]="asiento.ticket?.estado === 0"
                     [class.ocupado]="asiento.ticket?.estado === 1"
                     [class.bloqueado]="asiento.ticket?.estado === 2"
                     (click)="!modoPreview && seleccionarElemento(asiento, 'asiento', {filaIndex: i, asientoIndex: j}); $event.stopPropagation()">
                  <!-- Botón eliminar asiento -->
                  <button *ngIf="!modoPreview" 
                          class="icon-delete-corner" 
                          (click)="eliminarAsiento(i, j, $event); $event.stopPropagation()" 
                          title="Eliminar">
                    <i class="fas fa-times"></i>
                    <span class="delete-tooltip">Eliminar</span>
                  </button>
                  <!-- Seat Number -->
                  <span class="asiento-numero"
                        [style.color]="getEstilosAsiento(asiento, fila).color"
                        [style.font-size.px]="getEstilosAsiento(asiento, fila).fontSize">
                    {{asiento.ticket?.numero || (j + 1)}}
                  </span>
                </div>
              </div>
            </div>            <!-- Formas del mapa (libres) -->            <div *ngFor="let forma of mapa.formas; let k = index; trackBy: trackByForma"
                 class="forma-element"
                 [style.left.px]="getPosicionX(forma)"
                 [style.top.px]="getPosicionY(forma)"
                 [style.transform]="'rotate(' + getRotacion(forma) + 'deg)'"
                 [class.selected]="elementoSeleccionado === forma && !modoPreview"
                 [class.preview-mode]="modoPreview"
                 (click)="!modoPreview && seleccionarElemento(forma, 'forma', {formaIndex: k}); $event.stopPropagation()"
                 [draggable]="!modoPreview"
                 (dragstart)="!modoPreview && onDragStart($event, forma, 'forma')"
                 (dragend)="!modoPreview && onDragEnd($event)">
              
              <!-- Handle de rotación -->
              <div *ngIf="!modoPreview && elementoSeleccionado === forma"
                   class="rotation-handle"
                   (mousedown)="onRotationHandleMouseDown($event, forma)"
                   title="Rotar">
                <i class="fas fa-undo-alt"></i>
                <span *ngIf="isRotating && rotationPreview !== null" class="rotation-angle-label">{{ rotationPreview }}°</span>
              </div>
              <!-- Botón eliminar forma -->
              <button *ngIf="!modoPreview" 
                      class="icon-delete-corner" 
                      (click)="eliminarForma(k, $event); $event.stopPropagation()" 
                      title="Eliminar">
                <i class="fas fa-times"></i>
                <span class="delete-tooltip">Eliminar</span>
              </button>
              <!-- Visual Form -->
              <div class="forma-visual"
                   [style.width.px]="getEstilosForma(forma).width"
                   [style.height.px]="getEstilosForma(forma).height"
                   [style.background-color]="getEstilosForma(forma).backgroundColor"
                   [style.border-color]="getEstilosForma(forma).borderColor"
                   [style.border-width.px]="getEstilosForma(forma).borderWidth"
                   [style.border-radius]="forma.tipo === 2 ? '50%' : getEstilosForma(forma).borderRadius + 'px'"
                   [class.circular]="forma.tipo === 2"
                   style="border-style: solid; display: flex; align-items: center; justify-content: center; text-align: center;"
              >
                <span *ngIf="forma.texto" 
                      [style.color]="getEstilosForma(forma).color"
                      [style.font-size.px]="getEstilosForma(forma).fontSize"
                      style="width: 100%; word-break: break-word; white-space: pre-line;">
                  {{ forma.texto }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>    <!-- Right panel - Structure (hidden in preview mode) -->
    <div class="right-panel" [class.hidden-preview]="modoPreview">
      <div class="panel-header">
        <h3 class="panel-title">
          <i class="fas fa-sitemap icon"></i>
          Estructura del Mapa
        </h3>
      </div>
      
      <div class="panel-content">
        <!-- Propiedades del mapa -->
        <div class="map-properties">
          <h4>Propiedades del Mapa</h4>
          <div class="form-group">
            <label for="mapaNombre">Nombre:</label>
            <input type="text" id="mapaNombre" [(ngModel)]="mapa.nombre" class="form-control" placeholder="Nombre del mapa">
          </div>
        </div>

        <!-- Lista de filas -->
        <div class="filas-section">
          <h4>Filas ({{mapa.filas.length}})</h4>
          <div class="elements-list" 
               cdkDropList 
               (cdkDropListDropped)="reordenarFilas($event)">
            
            <div *ngFor="let fila of mapa.filas; let i = index; trackBy: trackByFila"
                 class="element-item"
                 cdkDrag>
              
              <div class="element-header" 
                   (click)="toggleFila(i)"
                   [class.expanded]="filaExpandida[i]">
                <i class="fas fa-grip-vertical drag-handle" cdkDragHandle></i>
                <i class="fas" [class.fa-chevron-down]="filaExpandida[i]" [class.fa-chevron-right]="!filaExpandida[i]"></i>
                <span class="element-name" (click)="seleccionarElemento(fila, 'fila', {filaIndex: i})">{{'Fila ' + (i + 1)}}</span>
                <div class="actions">
                  <button type="button" class="action-btn delete-btn" (click)="eliminarFila(i, $event)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>

              <!-- Contenido expandible de la fila -->
              <div class="element-content" *ngIf="filaExpandida[i]">
                <!-- Lista de asientos -->
                <div class="seats-list" *ngIf="fila.asientos.length > 0">
                  <div *ngFor="let asiento of fila.asientos; let j = index; trackBy: trackByAsiento" 
                       class="seat-item"
                       [style.width.px]="getEstilosAsiento(asiento, fila).width"
                       [style.height.px]="getEstilosAsiento(asiento, fila).height"
                       [style.background-color]="getEstilosAsiento(asiento, fila).backgroundColor"
                       [style.border-color]="getEstilosAsiento(asiento, fila).borderColor"
                       [style.border-width]="getEstilosAsiento(asiento, fila).borderWidth"
                       [style.border-radius]="getEstilosAsiento(asiento, fila).borderRadius + 'px'"
                       [style.color]="getEstilosAsiento(asiento, fila).color"
                       [style.font-size.px]="getEstilosAsiento(asiento, fila).fontSize"
                       (click)="seleccionarElemento(asiento, 'asiento', {filaIndex: i, asientoIndex: j})">
                    <i class="fas fa-chair"></i>
                    <span>{{asiento.ticket?.numero || 'S/N'}}</span>
                    <button type="button" class="action-btn delete-btn" (click)="eliminarAsiento(i, j, $event)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de formas -->
        <div class="formas-section">
          <h4>Formas ({{mapa.formas.length}})</h4>
          <div class="elements-list">
            <div *ngFor="let forma of mapa.formas; let k = index; trackBy: trackByForma"
                 class="element-item">
              
              <div class="element-header">
                <i class="fas fa-shapes"></i>
                <span class="element-name" (click)="seleccionarElemento(forma, 'forma', {formaIndex: k})"></span>
                <div class="actions">
                  <button type="button" class="action-btn delete-btn" (click)="eliminarForma(k, $event)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="spinner-overlay" *ngIf="cargando">
    <div class="spinner"></div>
  </div>

  <!-- Leyendas del mapa -->
  <app-leyendas-mapa
    [(leyendas)]="mapa.leyendas">
  </app-leyendas-mapa>
</div>