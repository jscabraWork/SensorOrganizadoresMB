<div *ngIf="cargando" class="spinner-overlay">
  <div class="spinner"></div>
</div>

<div class="pagina-editor-container" [class.modo-preview]="modoPreview">
  
  <app-title [title]="paginaId ? 'Modificar Página' : 'Crear Página'" [showBackButton]="true" (onBack)="atras()">
  </app-title>

  <app-navigation *ngIf="paginaId!=null" [menuItems]="menuItems" [showAddButton]="false"
    (onMenuItemClick)="toggleNavigation()">
  </app-navigation>

  <!-- Se muestra solo cuando NO estamos en la ruta de recursos -->
  <div *ngIf="!isRecursosRoute">
    <!-- Header solo visible en modo edición -->
    <div class="pagina-header">
      <form class="form-container">
        <div class="inputs">
          <input type="text" [(ngModel)]="pagina.nombre" placeholder="Nombre de la página" class="input-name"
            name="nombre">
        </div>

        <select [(ngModel)]="pagina.estado" class="input-select-field" name="estado">
          <option [value]="0" [selected]="pagina.estado === 0">Inactiva</option>
          <option [value]="1" [selected]="pagina.estado === 1">Activa</option>
          <option [value]="2" [selected]="pagina.estado === 2">Oculta</option>
        </select>

        <!-- Botón de Preview -->
        <div class="btn-preview" *ngIf="paginaId">
          <button type="button" (click)="togglePreview()" [class.active]="modoPreview">
            {{ modoPreview ? 'Editar' : 'Preview' }}
          </button>
        </div>

        <!-- Botón de Guardar -->
        <div class="btn-agregar">
          <button type="submit" (click)="save()" [disabled]="guardando">
            {{ guardando ? 'Guardando...' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>

    <div class="editor-layout">
      <div class="vista-previa-pagina" 
           [cdkDropListDisabled]="modoPreview"
           cdkDropList 
           (cdkDropListDropped)="reorganizarSecciones($event)">
        
        <div *ngFor="let seccion of pagina.secciones; let seccionIndex = index" 
             class="seccion-container" 
             [cdkDragDisabled]="modoPreview"
             cdkDrag>
          
          <!-- Header de sección solo visible en modo edición -->
          <div class="seccion-header" [class.oculto-preview]="modoPreview">
            <input class="nombre-seccion-input" 
                   type="text" 
                   [(ngModel)]="seccion.nombre"
                   placeholder="Sección sin nombre">
            <div class="seccion-acciones">
              <button class="btn-eliminar-seccion" (click)="eliminarSeccion(seccionIndex)">
                <span class="icono-eliminar">✖</span>
              </button>
            </div>
          </div>

          <div class="seccion-preview" 
               [ngStyle]="generarEstilosSeccion(seccion)"
               (click)="!modoPreview && seleccionarSeccion(seccionIndex)">
            
            <div class="seccion-contenido" 
                 [cdkDropListDisabled]="modoPreview"
                 cdkDropList
                 (cdkDropListDropped)="reorganizarContenido(seccionIndex, $event)">
              
              <div *ngFor="let contenido of seccion.contenido; let contenidoIndex = index" 
                   class="contenido-preview"
                   [ngClass]="{
                     'contenido-imagen': contenido.tipo === 0,
                     'contenido-video': contenido.tipo === 1,
                     'contenido-texto': contenido.tipo === 2,
                     'contenido-enlace': contenido.tipo === 3,
                     'modo-preview-contenido': modoPreview
                   }" 
                   [ngStyle]="generarEstilosContenido(contenido)" 
                   [cdkDragDisabled]="modoPreview"
                   cdkDrag
                   (click)="!modoPreview && seleccionarContenido(seccionIndex, contenidoIndex, $event)">
                
                <ng-container [ngSwitch]="contenido.tipo">
                  <!-- Imagen -->
                  <div *ngSwitchCase="0" class="contenido-imagen-interno"
                    [ngStyle]="generarEstilosImagenEspecificos(contenido)">
                    <img *ngIf="obtenerUrlRecurso(contenido)" 
                         [src]="obtenerUrlRecurso(contenido)"
                         [alt]="obtenerNombreRecurso(contenido)">
                  </div>

                  <!-- Video -->
                  <div *ngSwitchCase="1" class="contenido-video-interno">
                    <!-- Videos directos -->
                    <video *ngIf="esVideoDirecto(obtenerUrlRecurso(contenido))" 
                           [src]="obtenerUrlRecurso(contenido)"
                           [ngStyle]="generarEstilosContenido(contenido)"
                           [controls]="modoPreview">
                    </video>

                    <!-- Videos de plataformas (YouTube, Vimeo, etc) -->
                    <div *ngIf="!esVideoDirecto(obtenerUrlRecurso(contenido))" 
                         class="iframe-container"
                         [ngStyle]="generarEstilosContenido(contenido)">
                      <iframe [src]="obtenerUrlVideo(contenido)" 
                              frameborder="0"
                              allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
                              allowfullscreen>
                      </iframe>
                    </div>
                  </div>

                  <!-- Texto -->
                  <div *ngSwitchCase="2" class="contenido-texto-interno"
                    [ngStyle]="generarEstilosTextoEspecificos(contenido)">
                    {{ obtenerDescripcionContenido(contenido) }}
                  </div>

                  <!-- Enlace -->
                  <div *ngSwitchCase="3" class="contenido-enlace-interno"
                    [ngStyle]="generarEstilosEnlaceEspecificos(contenido)">
                    <a [href]="contenido.url" 
                       [target]="modoPreview ? '_blank' : '_self'"
                       [style.pointer-events]="modoPreview ? 'auto' : 'none'">
                      {{ obtenerDescripcionContenido(contenido) }}
                    </a>
                  </div>
                </ng-container>

                <!-- Botón eliminar solo visible en modo edición -->
                <button class="btn-eliminar" 
                        [class.oculto-preview]="modoPreview"
                        (click)="eliminarContenido(seccionIndex, contenidoIndex, $event)">
                  <span class="icono-eliminar">✖</span>
                </button>
              </div>

              <!-- Botón agregar contenido solo visible en modo edición -->
              <div class="agregar-contenido" 
                   [class.oculto-preview]="modoPreview"
                   (click)="agregarContenido(seccionIndex, $event)">
                + Agregar contenido
              </div>
            </div>
          </div>
        </div>

        <!-- Botón agregar sección solo visible en modo edición -->
        <div class="agregar-seccion" 
             [class.oculto-preview]="modoPreview"
             (click)="agregarSeccion()">
          + Agregar sección
        </div>
      </div>

      <!-- Panel de edición solo visible cuando no está en preview -->
      <div class="panel-edicion" *ngIf="panelAbierto && !modoPreview">
        <div class="acciones-panel-edicion">
          <button class="btn-cancelar" (click)="cancelarEdicion()">
            <span class="icono-cancelar">✖</span>
          </button>
        </div>

        <!-- Editor de Sección -->
        <app-propiedades-seccion *ngIf="seccionSeleccionada !== null && !contenidoSeleccionado"
          [seccion]="pagina.secciones[seccionSeleccionada]" (seccionCambiada)="actualizarSeccion($event)">
        </app-propiedades-seccion>

        <!-- Editor de Contenido -->
        <app-contenido-editor *ngIf="seccionSeleccionada !== null && contenidoSeleccionado !== null"
          [paginaId]="paginaId" [modoEdicion]="contenidoSeleccionado?.contenidoIndex !== null ? 'editar' : 'nuevo'"
          [contenidoExistente]="obtenerContenidoExistente()" (contenidoCreado)="actualizarContenido($event)">
        </app-contenido-editor>
      </div>
    </div>
  </div>

  <!-- Router Outlet para mostrar el componente de Recursos -->
  <div *ngIf="isRecursosRoute==true">
    <router-outlet></router-outlet>
  </div>
</div>