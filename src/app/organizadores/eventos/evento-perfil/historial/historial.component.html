  <!-- Header de página -->
  <app-titulo titulo="Historial de Transacciones"></app-titulo>

  <!-- Submenu de Estados -->
  <app-estado-submenu
    [opciones]="opcionesEstado"
    [estadoSeleccionado]="statusSeleccionado"
    (cambioEstado)="onCambioEstado($event)">
  </app-estado-submenu>

  <!-- Filtros -->
  <div class="filtros-container">
    <div class="filtros-grid">
      <!-- Tipo -->
      <div class="filtro-item">
        <label for="tipo">Tipo:</label>
        <select 
          id="tipo"
          [(ngModel)]="tipoSeleccionado" 
          (change)="actualizarFiltros()"
          class="form-select">
          <option *ngFor="let opcion of opcionesTipo" [value]="opcion.value">
            {{ opcion.label }}
          </option>
        </select>
      </div>

      <!-- Fecha inicio -->
      <div class="filtro-item">
        <label for="fechaInicio">Fecha inicio:</label>
        <input 
          id="fechaInicio"
          type="datetime-local"
          [(ngModel)]="fechaInicio"
          (change)="actualizarFiltros()"
          class="form-input">
      </div>

      <!-- Fecha fin -->
      <div class="filtro-item">
        <label for="fechaFin">Fecha fin:</label>
        <input 
          id="fechaFin"
          type="datetime-local"
          [(ngModel)]="fechaFin"
          (change)="actualizarFiltros()"
          class="form-input">
      </div>
    </div>
  </div>

  <!-- Botón Excel y Paginación Superior -->
  <div *ngIf="!error && historial && historial.length > 0" class="controles-superiores">
    <button 
      type="button" 
      class="btn-excel"
      (click)="descargarExcel()"
      [disabled]="cargando"
      title="Descargar Excel">
      <img src="assets/images/reporte/xls.svg" alt="Excel" class="excel-icon">
      <span class="btn-text">Descargar excel</span>
    </button>
    
    <app-paginacion 
      [config]="paginacionConfig"
      [showPageSizeSelector]="true"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (pageChange)="onPaginacionChange($event)">
    </app-paginacion>
  </div>

  <!-- Tabla de historial -->
  <div *ngIf="!error">
    <app-tabla-organizadores
      [datos]="historial"
      [columnas]="columnasTabla"
      [expandible]="true"
      [datosExpandidos]="obtenerDatosExpandidos"
      [plantillaSubtabla]="subtablaTemplate"
      [cargando]="cargando"
      [sinDatosMensaje]="'No se encontraron transacciones con los filtros seleccionados.'"
      [titulo]="'Historial de Transacciones'"
      [subtitulo]="evento?.nombre"
      (filaExpandida)="onFilaExpandida($event)">
    </app-tabla-organizadores>

    <!-- Template para subtabla de tickets -->
    <ng-template #subtablaTemplate let-item let-index="index">
      <!-- Subtabla de tickets -->
      <div class="tickets-section" *ngIf="item.tickets && item.tickets.length > 0">
        <h4 class="tickets-title">Tickets Asociados ({{ item.tickets.length }})</h4>
        <div class="tickets-table-responsive">
          <table class="tickets-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Estado</th>
                <th>Número</th>
                <th>Precio</th>
                <th>Servicio</th>
                <th>IVA</th>
                <th>Precio Total</th>
                <th>Tarifa</th>
                <th>Localidad</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let ticket of item.tickets">
                <td>{{ ticket.id }}</td>
                <td>{{ getTicketEstadoTexto(ticket.estado) }}</td>
                <td>{{ ticket.numero || 'No numerado' }}</td>
                <td class="text-right">{{ formatearMoneda(ticket.tarifa?.precio || 0) }}</td>
                <td class="text-right">{{ formatearMoneda(ticket.tarifa?.servicio || 0) }}</td>
                <td class="text-right">{{ formatearMoneda(ticket.tarifa?.iva || 0) }}</td>
                <td class="text-right">{{ formatearMoneda((ticket.tarifa?.precio || 0) + (ticket.tarifa?.servicio || 0) + (ticket.tarifa?.iva || 0)) }}</td>
                <td>{{ ticket.tarifa?.nombre || 'No asignada' }}</td>
                <td>{{ item.venta.localidad}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mensaje cuando no hay tickets -->
      <div class="no-tickets" *ngIf="!item.tickets || item.tickets.length === 0">
        <p>Esta orden no tiene tickets asociados.</p>
      </div>
    </ng-template>
  </div>

  <!-- Paginación Inferior -->
    <app-paginacion *ngIf="!error && historial && historial.length > 0"
      [config]="paginacionConfig"
      [showPageSizeSelector]="true"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (pageChange)="onPaginacionChange($event)">
    </app-paginacion>

  <!-- Estado de error -->
  <app-error 
    *ngIf="error"
    [mensaje]="error"
    (reintentar)="cargarDatos()">
  </app-error>